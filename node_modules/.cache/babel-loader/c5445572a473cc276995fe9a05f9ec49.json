{"ast":null,"code":"import _toConsumableArray from\"/home/bibhu/EDRdevelopment/DevBranch/edresearchweb/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"/home/bibhu/EDRdevelopment/DevBranch/edresearchweb/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef}from\"react\";import classes from\"./ChatWindow.module.css\";import ChatUserInfoTopBar from\"./ChatUserInfoTopBar\";import ChatScreen from\"./ChatScreen\";//import ChatInput from \"./ChatInput\";\nimport{w3cwebsocket as W3CWebSocket}from'websocket';//import { Picker } from \"emoji-mart\";\nimport\"emoji-mart/css/emoji-mart.css\";//import Login from '../../../../CommonApps/Login';\n//import axiosInstance from '../../../../axios';\nimport{MdSend}from'react-icons/md';import{postchatcomment,getchatcomments,getchatgroupbyId}from'../../../CommonApps/AllAPICalls';import{ImAttachment}from'react-icons/im';import{BsEmojiSmile}from'react-icons/bs';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";function Connect(){var client;var messageListeners=[];var _isConnected=false;var _componentMounted=false;//let reconnectOnClose = true;\nvar stateChangeListeners=[];function mountInfo(value){_componentMounted=value;}function on(fn){messageListeners.push(fn);}function off(fn){messageListeners=messageListeners.filter(function(l){return l!==fn;});}function onStateChange(fn){stateChangeListeners.push(fn);return function(){stateChangeListeners=stateChangeListeners.filter(function(l){return l!==fn;});};}function start(){{/*   \n    if (window.location.host === 'localhost:3000'){\t\n        client = new W3CWebSocket('ws://127.0.0.1:8000/ws/chat/class');\n      }\n\n      //wss://dpgclm6oad.execute-api.ca-central-1.amazonaws.com/production\n\n   if (window.location.host === '127.0.0.1:8000'){ \n       client = new W3CWebSocket('ws://127.0.0.1:8000/ws/chat/class/');\n      }\n\n \n   if (window.location.host === 'webapp.diracai.com'){ \n       client = new W3CWebSocket('wss://webapp.diracai.com:8001/ws/chat/class/');\n     }\n\n   if (window.location.host === 'app.diracai.com'){ \n       client = new W3CWebSocket('wss://app.diracai.com:8001/ws/chat/class/');\n     }\n   */}client=new W3CWebSocket('wss://app.diracai.com:8001/ws/chat/class/');//client = new W3CWebSocket('wss://edresearch.co.in:8001/ws/chat/class/');\n//const close = client.close;\n//client.close = () => {\n//   reconnectOnClose = false;\n//  close.call(client);\n//}\n// if(client.readyState === client.CLOSED ){\n//   setTimeout(start, 5000);\n//}\nclient.onclose=function(){_isConnected=false;stateChangeListeners.forEach(function(fn){return fn(false);});if(_componentMounted){setTimeout(start,5000);}};client.onopen=function(){_isConnected=true;stateChangeListeners.forEach(function(fn){return fn(true);});};client.onmessage=function(event){var dataFromServer=JSON.parse(event.data);messageListeners.forEach(function(fn){return fn(dataFromServer.message);});};}start();return{on:on,off:off,onStateChange:onStateChange,mountInfo:mountInfo,componentMounted:function componentMounted(){return _componentMounted;},getClient:function getClient(){return client;},isConnected:function isConnected(){return _isConnected;},close:function close(){return client.close();}};}var client=Connect();function useMessages(){var _useState=useState(['']),_useState2=_slicedToArray(_useState,2),messages=_useState2[0],setMessages=_useState2[1];useEffect(function(){function handleMessage(message){setMessages([].concat(_toConsumableArray(messages),[message]));}client.on(handleMessage);return function(){client.off(handleMessage);};},[messages,setMessages]);return messages;}var ChatWindow=function ChatWindow(props){//let clickedUserId=props.group.groupuserObjects[0].id !== props.userData.id? props.group.groupuserObjects[0] : props.group.groupuserObjects[1];\nvar mountedRef=useRef(true);var value=true;client.mountInfo(value);//this is commented out on April 5th 2022. Check if hat function works\n//const [isConnected, setIsConnected] = useState(client.isConnected());\nvar isConnected=client.isConnected();console.log('isConnected: ',isConnected);var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),commentObj=_useState4[0],setChatCommentObj=_useState4[1];var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),message=_useState6[0],setMessage=_useState6[1];var messages=useMessages();var lastMessage=messages.at(-1).split(\" \");var commentGroupId=Number(lastMessage[lastMessage.length-1]);//const commentUserId = Number(lastMessage[lastMessage.length - 2]);\nvar clickedGroupIdT=props.clickedGroupId;//const [localMessageSize, setlocalMessageSize]= useState(0);\nvar _useState7=useState(1),_useState8=_slicedToArray(_useState7,2),pageNum=_useState8[0],setPageNum=_useState8[1];var loadUpHandler=function loadUpHandler(){if(commentObj!==null&&commentObj.next!==null){setPageNum(function(pageNum){return pageNum+1;});}};var loadDownHandler=function loadDownHandler(){if(commentObj!==null&&commentObj.previous!==null){setPageNum(function(pageNum){return pageNum-1;});}};var displayMessage=[];if(commentGroupId===clickedGroupIdT){displayMessage=messages;}var handleChange=function handleChange(e){setMessage(function(msg){return e.target.value;});};useEffect(function(){return function(){mountedRef.current=false;client.mountInfo(false);// client.close();\n};},[isConnected]);var _useState9=useState(null),_useState10=_slicedToArray(_useState9,2),chatGroup=_useState10[0],getChatGroupById=_useState10[1];useEffect(function(){var groupId=props.clickedGroupId;var pageno=pageNum;console.log(\"groupId inside chatWindowTest: \",groupId);groupId!==0&&getchatcomments({setChatCommentObj:setChatCommentObj,groupId:groupId,pageno:pageno});groupId!==0&&getchatgroupbyId({groupId:groupId,getChatGroupById:getChatGroupById});},[props.clickedGroupId,props.userData.id,pageNum]);//console.log(\"chatGroup: \", chatGroup);\nfunction sendMessage(e){e.preventDefault();if(message!==\"\"){client.getClient().send(JSON.stringify({type:\"message\",message:message+\" \"+props.userData.id+\" \"+props.clickedGroupId}));var comment=message;var userId=props.userData.id;var groupId=props.clickedGroupId;postchatcomment({groupId:groupId,userId:userId,comment:comment});}setMessage('');}//console.log(\"displayMessage \", displayMessage);\n//console.log(\"commentObj: \", commentObj);\nreturn/*#__PURE__*/_jsxs(\"div\",{className:classes.chatWindow,children:[clickedGroupIdT===Number(0)&&/*#__PURE__*/_jsxs(\"div\",{className:classes.noGroupSelectDiv,children:[\" \",/*#__PURE__*/_jsx(\"b\",{children:\"Please select a chat to continue\"}),\" \"]}),clickedGroupIdT!==Number(0)&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ChatUserInfoTopBar,{chatGroup:chatGroup,userData:props.userData}),/*#__PURE__*/_jsx(ChatScreen,{messages:displayMessage,commentObj:commentObj!==null?commentObj.results:[],currentUser:props.userData.id,loadUpHandler:loadUpHandler,loadDownHandler:loadDownHandler,chatGroup:chatGroup}),/*#__PURE__*/_jsx(\"div\",{className:classes.chatInput,children:/*#__PURE__*/_jsxs(\"form\",{className:classes.addCommentForm,onSubmit:sendMessage,children:[/*#__PURE__*/_jsxs(\"button\",{type:\"button\",className:classes.uploadButton,children:[\" \",/*#__PURE__*/_jsx(BsEmojiSmile,{className:classes.uploadIcon})]}),/*#__PURE__*/_jsxs(\"button\",{type:\"button\",className:classes.uploadButton,children:[\" \",/*#__PURE__*/_jsx(ImAttachment,{className:classes.uploadIcon})]}),/*#__PURE__*/_jsx(\"div\",{className:classes.chatInput,children:/*#__PURE__*/_jsx(\"input\",{className:classes.inputTextBox,value:message,onChange:handleChange})}),/*#__PURE__*/_jsxs(\"button\",{type:\"submit\",className:classes.submit_button,children:[/*#__PURE__*/_jsxs(\"b\",{children:[/*#__PURE__*/_jsx(MdSend,{className:classes.sendButtonIcon}),\" \"]}),\" \"]})]})})]})]});};export default ChatWindow;","map":null,"metadata":{},"sourceType":"module"}