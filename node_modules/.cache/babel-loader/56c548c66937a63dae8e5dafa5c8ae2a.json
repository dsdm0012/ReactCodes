{"ast":null,"code":"import _toConsumableArray from\"/home/bibhu/EDRdevelopment/DevBranch/edresearchweb/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"/home/bibhu/EDRdevelopment/DevBranch/edresearchweb/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef}from\"react\";import classes from\"./ChatWindow.module.css\";import ChatUserInfoTopBar from\"./ChatUserInfoTopBar\";import ChatScreen from\"./ChatScreen\";//import ChatInput from \"./ChatInput\";\nimport{w3cwebsocket as W3CWebSocket}from'websocket';//import { Picker } from \"emoji-mart\";\nimport\"emoji-mart/css/emoji-mart.css\";//import Login from '../../../../CommonApps/Login';\n//import axiosInstance from '../../../../axios';\nimport{MdSend}from'react-icons/md';import{postchatcomment,getchatcomments,getchatgroupbyId}from'../../../CommonApps/AllAPICalls';import{ImAttachment}from'react-icons/im';import{BsEmojiSmile}from'react-icons/bs';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";function Connect(){var client;var messageListeners=[];var _isConnected=false;var _componentMounted=false;//let reconnectOnClose = true;\nvar stateChangeListeners=[];function mountInfo(value){_componentMounted=value;}function on(fn){messageListeners.push(fn);}function off(fn){messageListeners=messageListeners.filter(function(l){return l!==fn;});}function onStateChange(fn){stateChangeListeners.push(fn);return function(){stateChangeListeners=stateChangeListeners.filter(function(l){return l!==fn;});};}function start(){if(window.location.host==='localhost:3000'){client=new W3CWebSocket('ws://127.0.0.1:8000/ws/chat/class/');}//wss://dpgclm6oad.execute-api.ca-central-1.amazonaws.com/production\nif(window.location.host==='127.0.0.1:8000'){client=new W3CWebSocket('ws://127.0.0.1:8000/ws/chat/class/');}if(window.location.host==='webapp.diracai.com'){client=new W3CWebSocket('wss://webapp.diracai.com:8001/ws/chat/class/');}if(window.location.host==='app.diracai.com'){client=new W3CWebSocket('wss://app.diracai.com:8001/ws/chat/class/');}//client = new W3CWebSocket('wss://edresearch.co.in:8001/ws/chat/class/');\n//const close = client.close;\n//client.close = () => {\n//   reconnectOnClose = false;\n//  close.call(client);\n//}\n// if(client.readyState === client.CLOSED ){\n//   setTimeout(start, 5000);\n//}\nclient.onclose=function(){_isConnected=false;stateChangeListeners.forEach(function(fn){return fn(false);});if(_componentMounted){setTimeout(start,5000);}};client.onopen=function(){_isConnected=true;stateChangeListeners.forEach(function(fn){return fn(true);});};client.onmessage=function(event){var dataFromServer=JSON.parse(event.data);messageListeners.forEach(function(fn){return fn(dataFromServer.message);});};}start();return{on:on,off:off,onStateChange:onStateChange,mountInfo:mountInfo,componentMounted:function componentMounted(){return _componentMounted;},getClient:function getClient(){return client;},isConnected:function isConnected(){return _isConnected;},close:function close(){return client.close();}};}var client=Connect();function useMessages(){var _useState=useState(['']),_useState2=_slicedToArray(_useState,2),messages=_useState2[0],setMessages=_useState2[1];useEffect(function(){function handleMessage(message){setMessages([].concat(_toConsumableArray(messages),[message]));}client.on(handleMessage);return function(){client.off(handleMessage);};},[messages,setMessages]);return messages;}var ChatWindow=function ChatWindow(props){//let clickedUserId=props.group.groupuserObjects[0].id !== props.userData.id? props.group.groupuserObjects[0] : props.group.groupuserObjects[1];\nvar mountedRef=useRef(true);var value=true;client.mountInfo(value);//this is commented out on April 5th 2022. Check if hat function works\n//const [isConnected, setIsConnected] = useState(client.isConnected());\nvar isConnected=client.isConnected();console.log('isConnected: ',isConnected);var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),commentObj=_useState4[0],setChatCommentObj=_useState4[1];var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),message=_useState6[0],setMessage=_useState6[1];var messages=useMessages();var lastMessage=messages.at(-1).split(\" \");var commentGroupId=Number(lastMessage[lastMessage.length-1]);//const commentUserId = Number(lastMessage[lastMessage.length - 2]);\nvar clickedGroupIdT=props.clickedGroupId;//const [localMessageSize, setlocalMessageSize]= useState(0);\nvar _useState7=useState(1),_useState8=_slicedToArray(_useState7,2),pageNum=_useState8[0],setPageNum=_useState8[1];var loadUpHandler=function loadUpHandler(){if(commentObj!==null&&commentObj.next!==null){setPageNum(function(pageNum){return pageNum+1;});}};var loadDownHandler=function loadDownHandler(){if(commentObj!==null&&commentObj.previous!==null){setPageNum(function(pageNum){return pageNum-1;});}};var displayMessage=[];if(commentGroupId===clickedGroupIdT){displayMessage=messages;}var handleChange=function handleChange(e){setMessage(function(msg){return e.target.value;});};useEffect(function(){return function(){mountedRef.current=false;client.mountInfo(false);// client.close();\n};},[isConnected]);var _useState9=useState(null),_useState10=_slicedToArray(_useState9,2),chatGroup=_useState10[0],getChatGroupById=_useState10[1];useEffect(function(){var groupId=props.clickedGroupId;var pageno=pageNum;getchatcomments({setChatCommentObj:setChatCommentObj,groupId:groupId,pageno:pageno});getchatgroupbyId({groupId:groupId,getChatGroupById:getChatGroupById});},[props.clickedGroupId,props.userData.id,pageNum]);console.log(\"chatGroup: \",chatGroup);function sendMessage(e){e.preventDefault();if(message!==\"\"){client.getClient().send(JSON.stringify({type:\"message\",message:message+\" \"+props.userData.id+\" \"+props.clickedGroupId}));var comment=message;var userId=props.userData.id;var groupId=props.clickedGroupId;postchatcomment({groupId:groupId,userId:userId,comment:comment});}setMessage('');}//console.log(\"displayMessage \", displayMessage);\n//console.log(\"commentObj: \", commentObj);\nreturn/*#__PURE__*/_jsxs(\"div\",{className:classes.chatWindow,children:[clickedGroupIdT===Number(0)&&/*#__PURE__*/_jsxs(\"div\",{className:classes.noGroupSelectDiv,children:[\" \",/*#__PURE__*/_jsx(\"b\",{children:\"Please select a chat to continue\"}),\" \"]}),clickedGroupIdT!==Number(0)&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ChatUserInfoTopBar,{chatGroup:chatGroup,userData:props.userData}),/*#__PURE__*/_jsx(ChatScreen,{messages:displayMessage,commentObj:commentObj!==null?commentObj.results:[],currentUser:props.userData.id,loadUpHandler:loadUpHandler,loadDownHandler:loadDownHandler,chatGroup:chatGroup}),/*#__PURE__*/_jsx(\"div\",{className:classes.chatInput,children:/*#__PURE__*/_jsxs(\"form\",{className:classes.addCommentForm,onSubmit:sendMessage,children:[/*#__PURE__*/_jsxs(\"button\",{type:\"button\",className:classes.uploadButton,children:[\" \",/*#__PURE__*/_jsx(BsEmojiSmile,{className:classes.uploadIcon})]}),/*#__PURE__*/_jsxs(\"button\",{type:\"button\",className:classes.uploadButton,children:[\" \",/*#__PURE__*/_jsx(ImAttachment,{className:classes.uploadIcon})]}),/*#__PURE__*/_jsx(\"div\",{className:classes.chatInput,children:/*#__PURE__*/_jsx(\"input\",{className:classes.inputTextBox,value:message,onChange:handleChange})}),/*#__PURE__*/_jsxs(\"button\",{type:\"submit\",className:classes.submit_button,children:[/*#__PURE__*/_jsxs(\"b\",{children:[/*#__PURE__*/_jsx(MdSend,{className:classes.sendButtonIcon}),\" \"]}),\" \"]})]})})]})]});};export default ChatWindow;","map":{"version":3,"sources":["/home/bibhu/EDRdevelopment/DevBranch/edresearchweb/src/MainApps/Chat/ChatWindow/ChatWindowTest.js"],"names":["React","useState","useEffect","useRef","classes","ChatUserInfoTopBar","ChatScreen","w3cwebsocket","W3CWebSocket","MdSend","postchatcomment","getchatcomments","getchatgroupbyId","ImAttachment","BsEmojiSmile","Connect","client","messageListeners","isConnected","componentMounted","stateChangeListeners","mountInfo","value","on","fn","push","off","filter","l","onStateChange","start","window","location","host","onclose","forEach","setTimeout","onopen","onmessage","event","dataFromServer","JSON","parse","data","message","getClient","close","useMessages","messages","setMessages","handleMessage","ChatWindow","props","mountedRef","console","log","commentObj","setChatCommentObj","setMessage","lastMessage","at","split","commentGroupId","Number","length","clickedGroupIdT","clickedGroupId","pageNum","setPageNum","loadUpHandler","next","loadDownHandler","previous","displayMessage","handleChange","e","msg","target","current","chatGroup","getChatGroupById","groupId","pageno","userData","id","sendMessage","preventDefault","send","stringify","type","comment","userId","chatWindow","noGroupSelectDiv","results","chatInput","addCommentForm","uploadButton","uploadIcon","inputTextBox","submit_button","sendButtonIcon"],"mappings":"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","sourcesContent":["import React,{useState,useEffect,useRef} from \"react\";\nimport classes from \"./ChatWindow.module.css\"\nimport ChatUserInfoTopBar from \"./ChatUserInfoTopBar\";\nimport ChatScreen from \"./ChatScreen\";\n//import ChatInput from \"./ChatInput\";\nimport {w3cwebsocket as W3CWebSocket } from 'websocket';\n//import { Picker } from \"emoji-mart\";\nimport \"emoji-mart/css/emoji-mart.css\";\n//import Login from '../../../../CommonApps/Login';\n//import axiosInstance from '../../../../axios';\nimport {MdSend} from 'react-icons/md';\nimport {postchatcomment,getchatcomments, getchatgroupbyId} from '../../../CommonApps/AllAPICalls';\nimport {ImAttachment} from 'react-icons/im';\nimport {BsEmojiSmile} from 'react-icons/bs';\n\n\nfunction Connect (){\n\nlet client;\nlet messageListeners = [];\nlet isConnected = false;\nlet componentMounted = false;\n\n//let reconnectOnClose = true;\nlet stateChangeListeners = [];\n\n\nfunction mountInfo(value){\n\n  componentMounted = value;\n}\n\n\n\nfunction on(fn) {\n    messageListeners.push(fn);\n  }\n\n function off(fn) {\n    messageListeners = messageListeners.filter(l => l !== fn);\n  }\n\nfunction onStateChange(fn) {\n    stateChangeListeners.push(fn);\n    return () => {\n      stateChangeListeners = stateChangeListeners.filter(l => l !== fn);\n    };\n  }\n\n\n\n\n\n\n\n\nfunction start () {\n \n\n   \n    if (window.location.host === 'localhost:3000'){\t\n        client = new W3CWebSocket('ws://127.0.0.1:8000/ws/chat/class/');\n      }\n\n      //wss://dpgclm6oad.execute-api.ca-central-1.amazonaws.com/production\n\n   if (window.location.host === '127.0.0.1:8000'){ \n       client = new W3CWebSocket('ws://127.0.0.1:8000/ws/chat/class/');\n      }\n\n \n   if (window.location.host === 'webapp.diracai.com'){ \n       client = new W3CWebSocket('wss://webapp.diracai.com:8001/ws/chat/class/');\n     }\n\n   if (window.location.host === 'app.diracai.com'){ \n       client = new W3CWebSocket('wss://app.diracai.com:8001/ws/chat/class/');\n     }\n\n\n\n   \n\n   //client = new W3CWebSocket('wss://edresearch.co.in:8001/ws/chat/class/');\n\n\n\n    //const close = client.close;\n\n    //client.close = () => {\n    //   reconnectOnClose = false;\n    //  close.call(client);\n    //}\n\n   // if(client.readyState === client.CLOSED ){\n   //   setTimeout(start, 5000);\n    //}\n\n\n\n\n\n   client.onclose = () => {\n     isConnected=false;\n     stateChangeListeners.forEach(fn => fn(false));\t   \n     if(componentMounted){\t   \n       setTimeout(start, 5000);\n     }\n   }\n\n   client.onopen=()=>{\n     isConnected=true;\n     stateChangeListeners.forEach(fn => fn(true));\t   \n   }\n\n   client.onmessage = (event)=>{\n    const dataFromServer = JSON.parse(event.data);\t\n    messageListeners.forEach(fn => fn(dataFromServer.message));\n   }\n\n\n}\n\nstart();\n\n\n\n\n\n\n\nreturn {\n    on,\n    off,\n    onStateChange,\n    mountInfo,\n    componentMounted: ()=>componentMounted,\t\n    getClient: () => client,\n    isConnected: () => isConnected,\n    close: () => client.close(),\n   }\n}\n\nconst client = Connect();\n\n\n\nfunction useMessages() {\n  const [messages, setMessages] = useState(['']);\n\n  useEffect(() => {\n    function handleMessage(message) {\n      setMessages([...messages, message]);\n    }\n      client.on(handleMessage);\n     return () => {\n\t     client.off(handleMessage);\n             }\n  }, [messages, setMessages]);\n\n  return messages;\n}\n\n\n\n\n\n\n\nconst ChatWindow = (props) =>{\n\n\n\n    //let clickedUserId=props.group.groupuserObjects[0].id !== props.userData.id? props.group.groupuserObjects[0] : props.group.groupuserObjects[1];\n\n    const mountedRef = useRef(true);\n    let value=true;\n    client.mountInfo(value);\n    //this is commented out on April 5th 2022. Check if hat function works\n    //const [isConnected, setIsConnected] = useState(client.isConnected());\n  \n    let isConnected = client.isConnected();\n\n    console.log('isConnected: ', isConnected);\t\n\n    const [commentObj,setChatCommentObj]=useState(null);\n\n    const [message, setMessage] = useState('');\n   \n    const messages = useMessages();  \n\n    let lastMessage = messages.at(-1).split(\" \");\t\n\n    const commentGroupId = Number(lastMessage[lastMessage.length - 1]);\t\n\n    //const commentUserId = Number(lastMessage[lastMessage.length - 2]);\n   \t\n    const clickedGroupIdT= props.clickedGroupId;\n\n    //const [localMessageSize, setlocalMessageSize]= useState(0);\n\n    const [pageNum, setPageNum]= useState(1);\n\n    const loadUpHandler=()=>{\n\n      if(commentObj !==null && commentObj.next !==null){\n        setPageNum(pageNum=>pageNum + 1);\n       }\t   \n    }\n\n\n    const loadDownHandler=()=>{\n\n      if(commentObj !==null && commentObj.previous !==null){\n          setPageNum(pageNum=>pageNum - 1);\n        }\n\n    }\n\n\n\n\n\n\n   let displayMessage=[];\n  \n   if( commentGroupId === clickedGroupIdT ){\n      \n        displayMessage=messages;\t  \n\n     }\t\n\n   const handleChange = (e) => {\n      setMessage(msg=>e.target.value);\n\n\n   };\n\n   useEffect(()=>{\n     \n\n\n      return ()=>{\n         mountedRef.current = false;\n\t client.mountInfo(false);    \n        // client.close();\n       }\n     },[isConnected]);\n\n\n    const [chatGroup, getChatGroupById] = useState(null);\n\n\n   useEffect(()=>{\n     const groupId=props.clickedGroupId;\n     let pageno=pageNum;\n     getchatcomments({setChatCommentObj, groupId,pageno});\n     getchatgroupbyId({groupId, getChatGroupById});\n\n   },[props.clickedGroupId, props.userData.id,pageNum ]);\n\n\n\n    console.log(\"chatGroup: \", chatGroup);\n\n\n\n   function sendMessage(e) {\n    e.preventDefault();\n    if(message !== \"\"){\t   \n    client.getClient().send(JSON.stringify({\n      type: \"message\",\n      message: message+\" \"+props.userData.id+\" \"+props.clickedGroupId,\n    }))\n\n     const comment = message;\n     const userId = props.userData.id;\n\n     const groupId=props.clickedGroupId;\n     postchatcomment({groupId,userId,comment});\n\n    }\n    \t    \n    setMessage('');\n   }\n\n\n   //console.log(\"displayMessage \", displayMessage);\n\n\n   //console.log(\"commentObj: \", commentObj);\n\n\n\nreturn(\n\n\n\n\n<div className={classes.chatWindow}>\n\n\n\n  {clickedGroupIdT === Number(0) && <div className={classes.noGroupSelectDiv}> <b>Please select a chat to continue</b> </div>}\n\n\n\n { clickedGroupIdT !== Number(0) &&  <>\n\n      <ChatUserInfoTopBar chatGroup={chatGroup}\n\t                  userData={props.userData}\n\t\t          />\n\n      <ChatScreen messages={displayMessage}  \n\t          commentObj={commentObj !==null ? commentObj.results: []} \n\t          currentUser={props.userData.id}\n\t\t  loadUpHandler={loadUpHandler}\n\t          loadDownHandler={loadDownHandler}\n\t          chatGroup={chatGroup}\n\t\t  />\n\t\n    <div className={classes.chatInput}>\n\n        <form className={classes.addCommentForm} onSubmit={sendMessage}>\n\t\t  \n\t          <button type=\"button\" className={classes.uploadButton}> <BsEmojiSmile className={classes.uploadIcon}/></button>\n\n                  <button type=\"button\" className={classes.uploadButton}> <ImAttachment className={classes.uploadIcon}/></button>\n\n                  <div className={classes.chatInput} >\n\n                      <input className={classes.inputTextBox} value={message} onChange={handleChange} />\n\n\n                  </div>\n\n                 \n                 <button type=\"submit\"  className= {classes.submit_button} ><b><MdSend className={classes.sendButtonIcon}/> </b> </button>\n                  \n       </form>\n\n\n    </div>\n\n</>\n\n }\n\t\n</div>\n\n\n \n\n\n);\n\n}\n\nexport default ChatWindow;\n"]},"metadata":{},"sourceType":"module"}